import{getContext as d,start as m,Volume as f,PolySynth as p,Synth as g,MonoSynth as y,now as b}from"./audio-C2OqAgDD.js";class r{constructor(){if(r.instance)return r.instance;this.isInitialized=!1,this.isMobile=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),this.isIOS=/iPad|iPhone|iPod/.test(navigator.userAgent),this.touchStarted=!1,this.musicEnabled=!0,this.audioElements=new Map,this.masterVolume=null,this.synth=null,this.bass=null,r.instance=this,this.isIOS?this.setupIOSAudio():this.isMobile?this.setupMobileInit():this.init()}async setupIOSAudio(){console.log("🍎 iOS detected - setting up specialized audio initialization"),this.createAudioElements();const t=["touchstart","touchend","click","keydown"],n=async e=>{this.touchStarted||(console.log("🎵 iOS audio initialization triggered by:",e.type),this.touchStarted=!0,t.forEach(i=>{document.removeEventListener(i,n,{passive:!0})}),await this.initializeIOSAudio())};t.forEach(e=>{document.addEventListener(e,n,{passive:!0})})}createAudioElements(){const t={flip:this.createTone(800,.1),match:this.createTone(1200,.2),miss:this.createTone(400,.3),complete:this.createTone(1600,.5),achievement:this.createTone(2e3,.4)};Object.entries(t).forEach(([n,e])=>{const i=new Audio;i.src=e,i.preload="auto",i.volume=.3,this.audioElements.set(n,i)})}createTone(t,n){const i=Math.floor(44100*n),s=new ArrayBuffer(i*2),a=new DataView(s);for(let o=0;o<i;o++){const u=Math.sin(t*2*Math.PI*o/44100)*.3,c=Math.max(-32767,Math.min(32767,Math.floor(u*32767)));a.setInt16(o*2,c,!0)}return this.bufferToWav(s,44100)}bufferToWav(t,n){const e=t.byteLength,i=new ArrayBuffer(44+e),s=new DataView(i),a=(w,h)=>{for(let l=0;l<h.length;l++)s.setUint8(w+l,h.charCodeAt(l))};a(0,"RIFF"),s.setUint32(4,36+e,!0),a(8,"WAVE"),a(12,"fmt "),s.setUint32(16,16,!0),s.setUint16(20,1,!0),s.setUint16(22,1,!0),s.setUint32(24,n,!0),s.setUint32(28,n*2,!0),s.setUint16(32,2,!0),s.setUint16(34,16,!0),a(36,"data"),s.setUint32(40,e,!0);const o=new Uint8Array(t);new Uint8Array(i,44).set(o);const c=new Blob([i],{type:"audio/wav"});return URL.createObjectURL(c)}async initializeIOSAudio(){try{console.log("🎵 Initializing iOS-optimized audio..."),d().state==="suspended"&&(await m(),console.log("🎵 iOS Audio context resumed")),this.masterVolume=new f(-6).toDestination(),this.synth=new p(g).connect(this.masterVolume),this.bass=new y().connect(this.masterVolume),this.isInitialized=!0,console.log("✅ iOS audio engine initialized successfully")}catch(t){console.warn("⚠️ iOS audio initialization failed, using HTML5 audio:",t),this.isInitialized=!0}}setupMobileInit(){console.log("📱 Mobile detected - setting up audio initialization");const t=["touchstart","click"],n=async e=>{this.touchStarted||(console.log("🎵 Mobile audio initialization triggered by:",e.type),this.touchStarted=!0,t.forEach(i=>{document.removeEventListener(i,n)}),await this.init())};t.forEach(e=>{document.addEventListener(e,n,{passive:!0})})}async init(){if(!this.isInitialized)try{console.log("🎵 Initializing GameAudioEngine..."),d().state==="suspended"&&(await m(),console.log("🎵 Audio context resumed")),this.masterVolume=new f(-6).toDestination(),this.synth=new p(g).connect(this.masterVolume),this.bass=new y().connect(this.masterVolume),this.isInitialized=!0,console.log("✅ GameAudioEngine initialized successfully")}catch(t){console.error("❌ Failed to initialize GameAudioEngine:",t),this.isInitialized=!1}}async playSound(t,n={}){if(this.musicEnabled)try{if(this.isIOS&&this.audioElements.has(t)){const i=this.audioElements.get(t);i.currentTime=0,i.volume=n.volume||.3,await i.play().catch(s=>console.warn("HTML5 audio play failed:",s));return}if(!this.isInitialized||!this.synth){console.warn("Audio not initialized, skipping sound:",t);return}const e=b();switch(t){case"flip":this.synth.triggerAttackRelease("C5","16n",e);break;case"match":this.synth.triggerAttackRelease(["C5","E5","G5"],"8n",e);break;case"miss":this.bass.triggerAttackRelease("C3","4n",e);break;case"complete":this.synth.triggerAttackRelease(["C5","E5","G5","C6"],"2n",e);break;case"achievement":this.synth.triggerAttackRelease(["F5","A5","C6"],"4n",e);break;default:console.warn("Unknown sound type:",t)}}catch(e){console.warn("Failed to play sound:",t,e)}}onCardFlip(){this.playSound("flip")}onCardMatch(){this.playSound("match")}onCardMiss(){this.playSound("miss")}onGameComplete(){this.playSound("complete")}onAchievementUnlocked(){this.playSound("achievement")}setMusicEnabled(t){this.musicEnabled=t}cleanup(){this.synth&&this.synth.dispose(),this.bass&&this.bass.dispose(),this.masterVolume&&this.masterVolume.dispose(),this.audioElements.forEach(t=>{t.pause(),t.src=""}),this.audioElements.clear(),this.isInitialized=!1}}r.instance=null;const E=()=>new r;export{r as default,E as getAudioEngine};
